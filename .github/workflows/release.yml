name: Release

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  gate:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.resolve_tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Resolve tag
        id: resolve_tag
        run: |
          git fetch --tags --force
          head_ref="${{ github.event.workflow_run.head_branch }}"
          head_sha="${{ github.event.workflow_run.head_sha }}"

          tag=""
          if [[ "$head_ref" =~ ^v ]]; then
            if git show-ref --tags --verify --quiet "refs/tags/$head_ref"; then
              tag_sha="$(git rev-list -n1 "$head_ref")"
              if [[ "$tag_sha" == "$head_sha" ]]; then
                tag="$head_ref"
              fi
            fi
          elif [[ -z "$head_ref" ]]; then
            tag="$(git tag --points-at "$head_sha" | grep '^v' | head -n1 || true)"
          fi
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

  release:
    runs-on: ubuntu-latest
    needs: gate
    if: needs.gate.outputs.tag != ''
    permissions:
      id-token: write
      contents: read
    env:
      RELEASE_TAG: ${{ needs.gate.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install build
      - name: Verify tag matches package version
        run: |
          python - <<'PY'
          import os
          import tomllib
          tag = os.environ["RELEASE_TAG"]
          if tag.startswith("v"):
              tag = tag[1:]
          with open("pyproject.toml", "rb") as handle:
              version = tomllib.load(handle)["project"]["version"]
          if tag != version:
              raise SystemExit(f"Tag '{tag}' does not match pyproject version '{version}'")
          print(f"Tag matches version: {version}")
          PY
      - name: Build package
        run: python -m build
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
